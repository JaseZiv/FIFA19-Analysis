---
title: "FIFA19 Clustering"
author: "Jason Zivkovic"
date: "18/01/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Some things I want to analyse in this EDA:

- which features are highly correlated with a player's overall rating
- analyse the differences between a player's current rating and their potential rating
- find out which teams have the highest potential
- find out the youngest teams / oldest teams
- use k-means clustering to try to find "bargains"; ie if there is someone with the same skills/potential, can they be found for a bargain?



```{r}
# Load libraries
library(tidyverse)
library(DataExplorer)
library(scales)

options(scipen = 999)

fifa_data <- read_csv("data/data.csv")

fifa_data <- fifa_data %>%
  mutate(ValueMultiplier = ifelse(str_detect(Value, "K"), 1000, ifelse(str_detect(Value, "M"), 1000000, 1))) %>%
  mutate(ValueNumeric_pounds = as.numeric(str_extract(Value, "[0-9]+")) * ValueMultiplier) %>%
  mutate(Position = ifelse(is.na(Position), "Unknown", Position))

positions <- unique(fifa_data$Position)

gk <- "GK"
defs <- positions[str_detect(positions, "B$")]
mids <- positions[str_detect(positions, "M$")]
f1 <- positions[str_detect(positions, "F$")]
f2 <- positions[str_detect(positions, "S$")]
f3 <- positions[str_detect(positions, "T$")]
f4 <- positions[str_detect(positions, "W$")]
fwds <- c(f1, f2, f3, f4)

fifa_data <- fifa_data %>% 
  mutate(PositionGroup = ifelse(Position %in% gk, "GK", ifelse(Position %in% defs, "DEF", ifelse(Position %in% mids, "MID", ifelse(Position %in% fwds, "FWD", "Unknown")))))



```


```{r}



```




```{r}
plot_missing(fifa_data)
```

What are the most played positions in FIFA19
```{r}
fifa_data %>% 
  count(PositionGroup, sort = T) %>% 
  ggplot(aes(x= reorder(PositionGroup,n), y= n)) +
  geom_col() +
  coord_flip()


fifa_data %>%
  filter(PositionGroup != "Unknown") %>%
  count(PositionGroup, Position) %>%
  ggplot(aes(x= reorder(Position, n), y= n)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~ PositionGroup, scales = "free")
```

Which position has the highest valuations?
```{r}
fifa_data %>%
  filter(PositionGroup != "Unknown") %>%
  ggplot(aes(x= PositionGroup, y= ValueNumeric_pounds)) +
  geom_boxplot(color = "midnightblue", fill = "white") +
  scale_y_log10(labels = dollar_format(prefix = "€")) +
  coord_flip() +
  theme_bw()


fifa_data %>%
  filter(PositionGroup != "Unknown") %>%
  ggplot(aes(x= Position, y= ValueNumeric_pounds)) +
  geom_boxplot(color = "midnightblue", fill = "white") +
  scale_y_log10(labels = dollar_format(prefix = "€")) +
  coord_flip() +
  theme_bw() +
  facet_wrap(~ PositionGroup, scales = "free")

fifa_data %>%
  ggplot(aes(x= Position, y= log(ValueNumeric_pounds))) +
  geom_boxplot(color = "midnightblue", fill = "white") +
  coord_flip() +
  theme_bw()
```


```{r}
gk_vars <- fifa_data %>% select(contains("GK")) %>% names()


fifa_data %>%
  select_if(is.numeric) %>%
  select(-gk_vars) %>%
  as.matrix() %>%
  na.omit() %>%
  cor() %>%
  corrplot::corrplot()
```

Who are the biggest wildcards (players with the biggest differential between overall and potential)
```{r}
fifa_data %>%
  mutate(wildcard_rating = Potential - Overall) %>%
  arrange(desc(wildcard_rating)) %>%
  head(n=20) %>%
  ggplot(aes(x= reorder(Name, Potential), y= Overall)) +
  geom_bar(stat = "identity", position = "dodge", aes(y=Potential)) +
  coord_flip() +
  geom_text(aes(label = paste(wildcard_rating, Value)))
  
```


Is there a relationship between the players rating and valuation?
```{r}
fifa_data %>%
  ggplot(aes(x= Overall, y= ValueNumeric_pounds)) +
  geom_point(position = "jitter", alpha = 0.5) +
  scale_y_log10(labels = dollar_format(prefix = "€"))


value_rating_lm <- lm(ValueNumeric_pounds  ~ Overall + Age, data = fifa_data)

summary(value_rating_lm)

```

# Free Valuation Players

Are there some real bargains to be had?

```{r}
fifa_data %>%
  filter(ValueNumeric_pounds == 0) %>%
  ggplot(aes(x= Position, y= Overall)) +
  geom_boxplot() +
  coord_flip()

fifa_data %>%
  filter(ValueNumeric_pounds == 0) %>%
  ggplot(aes(x= Age, y= Overall)) +
  geom_text(aes(label = Name), check_overlap = T) +
  theme_classic()

```






